[manifest]
version = "1.0.0"
dump_lua = true
priority = 0

# context.payasaka_dos_before
# Runs before payasaka_before
[[patches]]
[patches.pattern]
target = 'functions/state_events.lua'
pattern = "-- context.before calculations"
position = 'before'
payload = '''
local should_return = PTASaka.dos_cardarea.disabled
PTASaka.dos_cardarea.disabled = true
SMODS.calculate_context({full_hand = G.play.cards, scoring_hand = scoring_hand, scoring_name = text, poker_hands = poker_hands, payasaka_dos_before = true})
'''
match_indent = true
times = 1

# Return cardarea state & Wild Two revert
[[patches]]
[patches.pattern]
target = 'functions/state_events.lua'
pattern = "-- TARGET: effects after hand evaluation"
position = 'after'
payload = '''
PTASaka.dos_cardarea.disabled = should_return
G.E_MANAGER:add_event(Event({
	func = function()
		for k, card in ipairs(G.play.cards) do
			if card.payasaka_wild_two then
				card:flip()
				--if card.children.front then
				--	card.children.front = nil
				--end
			end
		end
		return true
	end
}))
'''
match_indent = true
times = 1

# context.payasaka_before
[[patches]]
[patches.pattern]
target = 'functions/state_events.lua'
pattern = "-- context.before calculations"
position = 'before'
payload = '''
SMODS.calculate_context({full_hand = G.play.cards, scoring_hand = scoring_hand, scoring_name = text, poker_hands = poker_hands, payasaka_before = true})
'''
match_indent = true
times = 1

# Allow dynamic changing of hand chips and mult before scoring
[[patches]]
[patches.pattern]
target = 'functions/state_events.lua'
pattern = "-- TARGET: effects before scoring starts"
position = 'before'
payload = '''
text,disp_text,poker_hands,scoring_hand,non_loc_disp_text = G.FUNCS.get_poker_hand_info(G.play.cards)
'''
match_indent = true
times = 1

# Add fnnuy card area to calculate contexts
[[patches]]
[patches.pattern]
target = '''=[SMODS _ "src/utils.lua"]'''
pattern = "-- TARGET: add your own CardAreas for joker evaluation"
position = "after"
payload = '''
t[#t+1] = PTASaka.dos_cardarea
'''
match_indent = true
times = 1

# Change order of playing cards v. jokers when idk is present
[[patches]]
[patches.pattern]
target = 'functions/state_events.lua'
pattern = "for _, v in ipairs(SMODS.get_card_areas('playing_cards')) do"
position = "at"
payload = '''
local idk_present = next(SMODS.find_card('j_payasaka_idk'))
for _, v in ipairs(idk_present and {} or SMODS.get_card_areas('playing_cards')) do
'''
match_indent = true
times = 1

[[patches]]
[patches.pattern]
target = 'functions/state_events.lua'
pattern = "-- context.final_scoring_step calculations"
position = "before"
payload = '''
for _, v in ipairs(idk_present and SMODS.get_card_areas('playing_cards') or {}) do
	SMODS.calculate_main_scoring({cardarea = v, full_hand = G.play.cards, scoring_hand = scoring_hand, scoring_name = text, poker_hands = poker_hands}, v == G.play and scoring_hand or nil)
    delay(0.3)
end
'''
match_indent = true
times = 1

# Don't show debuff shader until its time
[[patches]]
[patches.pattern]
target = 'card.lua'
pattern = "self.children.center:draw_shader('debuff', nil, self.ARGS.send_to_shader)"
position = "at"
payload = '''
if not self.pta_no_show_debuff then self.children.center:draw_shader('debuff', nil, self.ARGS.send_to_shader) end
'''
match_indent = true
times = 1

[[patches]]
[patches.pattern]
target = 'card.lua'
pattern = "self.children.front:draw_shader('debuff', nil, self.ARGS.send_to_shader)"
position = "at"
payload = '''
if not self.pta_no_show_debuff then self.children.front:draw_shader('debuff', nil, self.ARGS.send_to_shader) end
'''
match_indent = true
times = 1

# Remove retriggers if Aww! No Retriggers is present
# ALL of them
[[patches]]
[patches.pattern]
target = '''=[SMODS _ "src/utils.lua"]'''
pattern = "if _type == 'joker_retrigger' then"
position = "before"
payload = '''
if PTASaka.stop_you_are_violating_the_law then 
	effect = { fake_repetitions = eval.repetitions or 1 }
	if _type == 'joker_retrigger' then
            effect.retrigger_card = effect_card
            effect.message_card = effect.message_card or effect_card
            effect.retrigger_flag = true
        elseif _type == 'individual_retrigger' then
            effect.retrigger_card = effect_card.object
            effect.message_card = effect.message_card or effect_card.scored_card
        elseif not _type then
            effect.card = effect.card or effect_card
        end
	eval.repetitions = 0
	table.insert(ret, _type == "joker_retrigger" and effect or { retriggers = effect });
	return 
end
'''
match_indent = true
times = 1

# Hijack
[[patches]]
[patches.pattern]
target = '''=[SMODS _ "src/utils.lua"]'''
pattern = "if eval.retriggers then"
position = "at"
payload = '''
if PTASaka.stop_you_are_violating_the_law and eval.retriggers then 
	SMODS.calculate_effect(eval.retriggers, eval.retriggers.retrigger_card or eval.retriggers.card)
	eval.retriggers = nil
elseif eval.retriggers then
'''
match_indent = true
